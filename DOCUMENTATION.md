# LoCode ComfyUI - Документация

Полная документация для пользователей набора кастомных нодов LoCode для ComfyUI.

## Содержание

1. [Введение](#введение)
2. [Установка](#установка)
3. [Категории нодов](#категории-нодов)
   - [Вычисления (calc)](#вычисления-calc)
   - [Преобразования (convert)](#преобразования-convert)
   - [Списки (lists)](#списки-lists)
   - [Замена (replacers)](#замена-replacers)
   - [Утилиты (utils)](#утилиты-utils)
   - [Системные (system)](#системные-system)
   - [Параметры (params)](#параметры-params)
4. [Утилиты](#утилиты)
5. [Примеры использования](#примеры-использования)

---

## Введение

**LoCode** - это набор кастомных нодов для ComfyUI, предназначенный для расширения функциональности работы с данными, вычислениями, списками и системными операциями. Ноды организованы по категориям для удобной навигации.

### Основные возможности

- Математические вычисления и сравнения
- Преобразование типов данных
- Работа со списками
- Замена переменных в строках
- Системные операции с файлами и директориями
- Утилиты для логирования и отладки
- Управление параметрами и свойствами

---

## Установка

1. Поместите папку `locode-comfy` в директорию `ComfyUI/custom_nodes/`
2. Перезапустите ComfyUI или используйте **Reload Custom Nodes** в меню

---

## Категории нодов

### Вычисления (calc)

#### Lo:Evals
**Вычисление выражений с переменными**

Вычисляет результат математического выражения с использованием переменных из входных параметров.

**Входы:**
- `expression` (STRING) - Выражение для вычисления (многострочное). Имена переменных берутся из имен входных параметров или их меток (labels).
- `*` (ANY) - Любое количество входных параметров любого типа. Имя переменной в выражении соответствует имени входного параметра (или его метке).

**Выходы:**
- `int` (INT) - Целочисленный результат
- `float` (FLOAT) - Вещественный результат
- `bool` (BOOLEAN) - Логический результат

**Особенности:**
- Имена переменных можно изменить через контекстное меню > "Rename Slot"
- Поддерживает многострочные выражения
- Автоматически преобразует входные значения в числа где возможно

**Пример:**
```
expression: "x0 + x1 * 2"
x0 = 5
x1 = 3
Результат: int=11, float=11.0, bool=True
```

---

#### Lo:CompareNum
**Сравнение двух чисел**

Сравнивает два значения, автоматически преобразуя их в числа.

**Входы:**
- `a` (ANY) - Первое значение
- `b` (ANY) - Второе значение
- `operation` (SELECT) - Операция сравнения:
  - `a>b` - больше
  - `a<b` - меньше
  - `a=b` - равно
  - `a!=b` - не равно
  - `a>=b` - больше или равно
  - `a<=b` - меньше или равно
  - `a % b = 0` - проверка делимости (остаток от деления равен 0)

**Выходы:**
- `bool` (BOOLEAN) - Результат сравнения

**Пример:**
```
a = 10
b = 5
operation = "a>b"
Результат: True
```

---

#### Lo:RandomNum
**Генерация случайного числа**

Генерирует случайное число в заданном диапазоне.

**Входы:**
- `min` (FLOAT) - Минимальное значение
- `max` (FLOAT) - Максимальное значение

**Выходы:**
- `int` (INT) - Случайное целое число
- `float` (FLOAT) - Случайное вещественное число

**Особенности:**
- Результат меняется при каждом выполнении (не кэшируется)

**Пример:**
```
min = 1.0
max = 10.0
Результат: int=7, float=7.234
```

---

#### Lo:RandomBool
**Генерация случайного логического значения**

Генерирует случайное логическое значение с заданной вероятностью.

**Входы:**
- `true_weight` (FLOAT) - Вероятность получить `True` (от 0.0 до 1.0, по умолчанию 0.5)

**Выходы:**
- `bool` (BOOLEAN) - Случайное логическое значение

**Особенности:**
- Результат меняется при каждом выполнении (не кэшируется)
- `true_weight = 0.5` означает равную вероятность True и False

**Пример:**
```
true_weight = 0.7
Результат: True (с вероятностью 70%)
```

---

#### Lo:IsEmpty
**Проверка на пустоту**

Проверяет, является ли значение пустым.

**Входы:**
- `any` (ANY) - Любое значение для проверки

**Выходы:**
- `bool` (BOOLEAN) - `True` если значение пустое, `False` иначе

**Логика проверки:**
- `None` → `True`
- Пустая строка `""` → `True`
- Строка только с пробелами → `True`
- Все остальное → `False`

**Пример:**
```
any = ""
Результат: True

any = "text"
Результат: False
```

---

#### Lo:Eval (Устаревший)
**Вычисление выражения (старая версия)**

Вычисляет выражение с фиксированными переменными `a`, `b`, `c`.

---

### Преобразования (convert)

#### Lo:ToInt
**Преобразование в целое число**

Преобразует любое значение в целое число с выбором метода округления.

**Входы:**
- `any` (ANY) - Значение для преобразования
- `method` (SELECT) - Метод округления:
  - `floor` - Округление вниз
  - `ceil` - Округление вверх
  - `round` - Обычное округление

**Выходы:**
- `int` (INT) - Целое число

**Пример:**
```
any = 7.7
method = "floor"
Результат: 7

method = "ceil"
Результат: 8

method = "round"
Результат: 8
```

---

#### Lo:ToFloat
**Преобразование в вещественное число**

Преобразует любое значение в вещественное число.

**Входы:**
- `any` (ANY) - Значение для преобразования

**Выходы:**
- `float` (FLOAT) - Вещественное число

**Пример:**
```
any = "123.45"
Результат: 123.45
```

---

#### Lo:ToStr
**Преобразование в строку**

Преобразует любое значение в строку.

**Входы:**
- `any` (ANY) - Значение для преобразования

**Выходы:**
- `string` (STRING) - Строковое представление значения

**Пример:**
```
any = 123
Результат: "123"
```

---

#### Lo:ToBool
**Преобразование в логическое значение**

Преобразует любое значение в логическое с возможностью инверсии.

**Входы:**
- `any` (ANY) - Значение для преобразования
- `invert` (BOOLEAN) - Инвертировать результат (по умолчанию `False`)

**Выходы:**
- `bool` (BOOLEAN) - Логическое значение

**Правила преобразования:**
- `None` → `False`
- Числа: `0` → `False`, любое другое → `True`
- Строки: `"false"`, `"0"`, `"no"`, `"off"`, `""` (пустая) → `False`, остальное → `True`
- Коллекции (списки, словари и т.д.): пустые → `False`, непустые → `True`
- Остальные типы: стандартное преобразование Python `bool()`

**Пример:**
```
any = 0
invert = False
Результат: False

any = "yes"
invert = False
Результат: True

any = True
invert = True
Результат: False
```

---

### Списки (lists)

#### Lo:SetList
**Создание списка из входных параметров**

Создает список из всех входных параметров любого типа.

**Входы:**
- `*` (ANY) - Любое количество входных параметров любого типа

**Выходы:**
- `list` (LIST) - Список значений
- `length` (INT) - Длина списка

**Пример:**
```
Входы: "text", 123, True
Результат: list=["text", 123, True], length=3
```

---

#### Lo:FromList
**Получение элемента из списка по индексу**

Извлекает элемент из списка по указанному индексу.

**Входы:**
- `index` (INT) - Индекс элемента (по умолчанию 0)
- `any_list` (LIST) - Список значений
- `modulo` (BOOLEAN) - Использовать модуло для обертки индекса (по умолчанию `False`)
- `none_on_error` (BOOLEAN) - Возвращать `None` вместо ошибки (по умолчанию `False`)

**Выходы:**
- `any` (ANY) - Элемент списка

**Особенности:**
- Если `modulo=True`, индекс оборачивается: `index % длина_списка`
- Если `modulo=False` и индекс вне диапазона, выбрасывается ошибка (или возвращается `None` если `none_on_error=True`)

**Пример:**
```
any_list = ["a", "b", "c"]
index = 1
modulo = False
Результат: "b"

index = 10
modulo = True
Результат: "a" (10 % 3 = 1, но индекс 1 это "b", нет - 10 % 3 = 1, элемент с индексом 1 это "b")
```

---

#### Lo:ListLen
**Длина списка**

Возвращает количество элементов в списке.

**Входы:**
- `any_list` (LIST) - Список значений

**Выходы:**
- `count` (INT) - Количество элементов

**Пример:**
```
any_list = [1, 2, 3, 4, 5]
Результат: 5
```

---

#### Lo:ListJoin
**Объединение списка в строку**

Объединяет элементы списка в одну строку с указанным разделителем.

**Входы:**
- `list` (LIST) - Список значений (будут преобразованы в строки)
- `delimiter` (STRING) - Разделитель (по умолчанию `"\n"`)

**Выходы:**
- `string` (STRING) - Объединенная строка

**Особенности:**
- Поддерживает специальные символы: `\n` (новая строка), `\t` (табуляция)
- Все элементы автоматически преобразуются в строки

**Пример:**
```
list = ["a", "b", "c"]
delimiter = ", "
Результат: "a, b, c"

delimiter = "\n"
Результат: "a\nb\nc"
```

---

#### Lo:StrList
**Разделение строки на список**

Разделяет строку на список строк по указанному разделителю.

**Входы:**
- `string` (STRING) - Строка для разделения (многострочное)
- `delimiter` (STRING) - Разделитель (по умолчанию `"\n"`)
- `trim` (BOOLEAN) - Удалять пробелы по краям каждого элемента (по умолчанию `False`)

**Выходы:**
- `list` (LIST) - Список строк

**Особенности:**
- Поддерживает специальные символы: `\n`, `\t`
- Если `trim=True`, удаляются пробелы в начале и конце каждого элемента

**Пример:**
```
string = "apple\nbanana\ncherry"
delimiter = "\n"
trim = False
Результат: ["apple", "banana", "cherry"]

string = "  apple  ,  banana  ,  cherry  "
delimiter = ","
trim = True
Результат: ["apple", "banana", "cherry"]
```

---

#### Lo:NumList
**Создание списка чисел из строки**

Преобразует строку с числами в списки целых и вещественных чисел.

**Входы:**
- `string` (STRING) - Строка с числами, разделенными запятыми (многострочное)

**Выходы:**
- `int_list` (LIST) - Список целых чисел
- `float_list` (LIST) - Список вещественных чисел

**Особенности:**
- Разделитель - запятая
- Автоматически удаляет все символы, не являющиеся числами, знаками и запятыми
- Целые числа округляются вниз (floor)

**Пример:**
```
string = "1, 2.5, 3.7, 4"
Результат: 
  int_list = [1, 2, 3, 4]
  float_list = [1.0, 2.5, 3.7, 4.0]
```

---

#### Lo:ListsMerge
**Объединение нескольких списков**

Объединяет несколько списков в один.

**Входы:**
- `remove_dupes` (BOOLEAN) - Удалять дубликаты (по умолчанию `False`)
- `*` (LIST или ANY) - Любое количество списков или значений

**Выходы:**
- `list` (LIST) - Объединенный список
- `length` (INT) - Длина объединенного списка

**Особенности:**
- Если входное значение не список, оно добавляется как отдельный элемент
- Если `remove_dupes=True`, удаляются повторяющиеся элементы (сохраняется порядок первого вхождения)

**Пример:**
```
Списки: [1, 2], [3, 4], [5]
remove_dupes = False
Результат: [1, 2, 3, 4, 5], length=5

Списки: [1, 2], [2, 3], [3, 4]
remove_dupes = True
Результат: [1, 2, 3, 4], length=4
```

---

### Замена (replacers)

#### Lo:ReplaceVars
**Замена переменных в строке**

Заменяет переменные в строке, заключенные в фигурные скобки `{var}`, значениями из входных параметров.

**Входы:**
- `string` (STRING) - Строка с переменными (многострочное)
- `*` (ANY) - Любое количество входных параметров. Имя переменной в строке соответствует имени входного параметра (или его метке).

**Выходы:**
- `string` (STRING) - Строка с замененными переменными

**Особенности:**
- Имена переменных можно изменить через контекстное меню > "Rename Slot"
- Переменные в строке должны быть в формате `{имя_переменной}`
- Если переменная не найдена, она остается как есть

**Пример:**
```
string = "Hello, {name}! You have {count} items."
name = "Alice"
count = 5
Результат: "Hello, Alice! You have 5 items."
```

---

#### Lo:Replacers
**Создание списка замен**

Создает список пар "найти-заменить" для последующего использования.

**Входы:**
- `string` (STRING, опционально) - Строка для немедленной замены
- `replacers` (STRING, скрытое) - JSON строка со списком замен в формате `[["find", "replace"], ...]`

**Выходы:**
- `STRING` (STRING) - Строка после замены (если входная строка была указана)
- `replacers` (LIST) - Список пар замен

**Особенности:**
- Используется вместе с `Lo:ReplacersApply` для применения замен
- Формат данных: список списков, где каждый внутренний список содержит `[что_найти, на_что_заменить]`

**Пример:**
```
replacers = [["old", "new"], ["cat", "dog"]]
string = "old cat"
Результат: STRING="new dog", replacers=[["old", "new"], ["cat", "dog"]]
```

---

#### Lo:ReplacersApply
**Применение списка замен**

Применяет список замен из `Lo:Replacers` к строке.

**Входы:**
- `string` (ANY) - Строка для обработки
- `replacers` (LIST) - Список замен из `Lo:Replacers` в формате `[["find", "replace"], ...]`

**Выходы:**
- `STRING` (STRING) - Строка после применения всех замен

**Пример:**
```
string = "I have an old cat"
replacers = [["old", "new"], ["cat", "dog"]]
Результат: "I have a new dog"
```

---

### Утилиты (utils)

#### Lo:Log
**Логирование значений**

Выводит любое значение в консоль ComfyUI с временными метками и опциональным звуковым уведомлением.

**Входы:**
- `any` (ANY) - Значение для вывода
- `name` (STRING) - Имя для идентификации в логе
- `reset` (BOOLEAN) - Сбросить точку отсчета времени
- `sound` (SELECT) - Звук уведомления:
  - `none` - Без звука
  - `beep` - Обычный сигнал
  - `bdin` - Звук "bdin"
  - `drop` - Звук "drop"
  - `jink` - Звук "jink"
  - `notify` - Уведомление

**Выходы:**
- `any` (ANY) - Передает входное значение без изменений

**Особенности:**
- Выводит время с момента первого вызова и время с предыдущего вызова
- Полезен для отладки и мониторинга выполнения
- Не влияет на поток данных (OUTPUT_NODE)

**Пример вывода в консоль:**
```
    Lo:Log [00:00:01 / 00:00:05]:
123
```

---

#### Lo:Beep
**Воспроизведение звука**

Воспроизводит звуковое уведомление без изменения данных.

**Входы:**
- `any` (ANY) - Любое значение (проходит без изменений)
- `sound` (SELECT) - Звук для воспроизведения (те же опции, что и в `Lo:Log`)

**Выходы:**
- `any` (ANY) - Передает входное значение без изменений

**Особенности:**
- Полезен для уведомлений о завершении этапов обработки
- Не влияет на поток данных

---

#### Lo:Switcher
**Переключатель значений**

Выбирает одно значение из списка входных значений на основе индекса.

**Входы:**
- `index_seed` (INT) - Индекс для выбора (по умолчанию 0)
- `*` (ANY) - Любое количество входных значений любого типа

**Выходы:**
- `*` (ANY) - Выбранное значение

**Особенности:**
- Индекс автоматически оборачивается через модуло: `index_seed % количество_значений`
- Игнорирует `None` значения
- Если нет значений, выбрасывается ошибка

**Пример:**
```
index_seed = 2
Входы: "apple", "banana", "cherry"
Результат: "cherry"

index_seed = 5
Входы: "apple", "banana", "cherry"
Результат: "banana" (5 % 3 = 2, но индекс 2 это "cherry" - нет, 5 % 3 = 2, элемент с индексом 2 это "cherry")
```

---

#### Lo:Counter
**Двухпозиционный счетчик**

Двухпозиционный счетчик с основным (major) и дополнительным (minor) счетчиками.

**Входы:**
- `major` (INT) - Основной счетчик (по умолчанию 0)
- `minor` (INT) - Дополнительный счетчик (по умолчанию 0)
- `max_minor` (INT) - Максимальное значение для minor (по умолчанию 5, минимум 0)

**Выходы:**
- `major` (INT) - Основной счетчик
- `minor` (INT) - Дополнительный счетчик
- `max_minor` (INT) - Максимальное значение для minor

**Логика работы:**
- Когда `minor` становится больше `max_minor`, он должен сброситься в 0, а `major` увеличиться на 1
- Если `minor` уже больше `max_minor`, он устанавливается равным `max_minor`

**Пример использования:**
```
major = 0, minor = 0, max_minor = 5
→ major = 0, minor = 0

minor = 6 (больше max_minor)
→ major = 0, minor = 5 (ограничивается max_minor)
```

---

### Системные (system)

#### Lo:MkDir
**Создание директории**

Создает директорию, если она не существует.

**Входы:**
- `path` (STRING) - Путь к директории для создания

**Выходы:**
- `path` (STRING) - Путь к директории
- `created` (BOOLEAN) - `True` если директория была создана, `False` если уже существовала или произошла ошибка

**Особенности:**
- Создает все промежуточные директории (как `mkdir -p`)
- Не выдает ошибку, если директория уже существует

**Пример:**
```
path = "output/images"
Результат: path="output/images", created=True
```

---

#### Lo:ReadDir
**Чтение содержимого директории**

Читает содержимое директории и разделяет на файлы и поддиректории.

**Входы:**
- `path` (STRING) - Путь к директории

**Выходы:**
- `all` (LIST) - Список всех элементов (файлы и директории)
- `files` (LIST) - Список только файлов
- `dirs` (LIST) - Список только директорий

**Пример:**
```
path = "output"
Результат:
  all = ["image1.png", "image2.jpg", "subfolder"]
  files = ["image1.png", "image2.jpg"]
  dirs = ["subfolder"]
```

---

#### Lo:FileExists
**Проверка существования файла или директории**

Проверяет, существует ли указанный файл или директория.

**Входы:**
- `path` (STRING) - Путь к файлу или директории

**Выходы:**
- `exists` (BOOLEAN) - `True` если существует, `False` иначе
- `is_dir` (BOOLEAN) - `True` если это директория, `False` иначе (или если не существует)

**Пример:**
```
path = "output/image.png"
Результат: exists=True, is_dir=False

path = "output"
Результат: exists=True, is_dir=True
```

---

#### Lo:CountDirImages
**Подсчет изображений в директории**

Подсчитывает количество изображений (png, jpg, jpeg, webp) в указанной директории.

**Входы:**
- `path` (STRING) - Путь к директории

**Выходы:**
- `count` (INT) - Количество изображений, или `-1` при ошибке

**Особенности:**
- Поддерживаемые форматы: `.png`, `.jpg`, `.jpeg`, `.webp`
- Возвращает `-1` если директория не существует или произошла ошибка

**Пример:**
```
path = "output"
Результат: count=15 (если в директории 15 изображений)
```

---

#### Lo:RmDir
**Удаление директории**

⚠️ **EXPERIMENTAL** - Экспериментальная функция, используйте с осторожностью.

Удаляет директорию со всем содержимым.

**Входы:**
- `path` (STRING) - Путь к директории для удаления
- `pass_any` (ANY, опционально) - Значение, которое проходит через узел без изменений

**Выходы:**
- `pass_any` (ANY) - Передает входное значение без изменений

**Особенности:**
- Удаляет директорию даже если она не пустая
- Ошибки выводятся в консоль, но не прерывают выполнение

**Внимание:** Будьте осторожны при использовании этого узла, так как он безвозвратно удаляет данные!

---

### Параметры (params)

#### Lo:SetProps
**Упаковка параметров**

Упаковывает несколько значений в один объект для передачи через граф.

**Входы:**
- `*` (ANY) - Любое количество входных параметров любого типа

**Выходы:**
- `props` (LO_PROPS) - Упакованный объект параметров

**Особенности:**
- Используется вместе с `Lo:GetProps` для передачи данных
- Сохраняет типы данных всех параметров
- Позволяет передавать несколько значений через одно соединение

**Пример:**
```
Входы: width=1280, height=720, fps=24.0
Выход: props (объект с этими значениями)
```

---

#### Lo:GetProps
**Распаковка параметров**

Извлекает параметры из объекта `Lo:SetProps`.

**Входы:**
- `props` (LO_PROPS) - Объект параметров из `Lo:SetProps`

**Выходы:**
- `*` (ANY) - Выходные параметры соответствуют типам, указанным в узле

**Особенности:**
- Типы данных должны совпадать с типами в `Lo:SetProps`
- Позволяет использовать `*` или `ANY` для приема любых типов
- Выбрасывает ошибку при несоответствии типов

**Пример:**
```
props (из Lo:SetProps с width, height, fps)
Выходы: width (INT), height (INT), fps (FLOAT)
```

---

#### Lo:Texts
**Выбор текста из массива**

Выбирает текст из массива текстов по индексу или активной вкладке.

**Входы:**
- `index_seed` (INT) - Индекс для выбора текста (по умолчанию 0)

**Выходы:**
- `ACTIVE_STRING` (STRING) - Текст активной вкладки
- `INDEX_STRING` (STRING) - Текст по указанному индексу
- `LIST` (LIST) - Список всех текстов

**Особенности:**
- Использует веб-интерфейс с вкладками для управления текстами
- Индекс автоматически оборачивается через модуло
- Поддерживает отключение отдельных вкладок

**Пример:**
```
Вкладки: ["Text 1", "Text 2", "Text 3"]
activeIndex = 1
index_seed = 0
Результат:
  ACTIVE_STRING = "Text 2"
  INDEX_STRING = "Text 1"
  LIST = ["Text 1", "Text 2", "Text 3"]
```

---

#### Lo:SetVideoProps
**Установка параметров видео**

Создает объект с параметрами видео и вычисляет количество кадров.

**Входы:**
- `width` (INT) - Ширина видео (по умолчанию 1280)
- `height` (INT) - Высота видео (по умолчанию 720)
- `duration` (FLOAT) - Продолжительность в секундах (по умолчанию 4.0)
- `fps` (FLOAT) - Кадров в секунду (по умолчанию 24.0)

**Выходы:**
- `video_props` (LO_VIDEO_PROPS) - Объект параметров видео
- `width` (INT) - Ширина
- `height` (INT) - Высота
- `duration` (FLOAT) - Продолжительность
- `fps` (FLOAT) - Кадров в секунду
- `frames` (INT) - Количество кадров (округлено до кратного 4)

**Особенности:**
- Количество кадров округляется до кратного 4
- Вычисляет финальную продолжительность на основе количества кадров
- Выбрасывает ошибку, если какой-либо параметр не задан или <= 0

**Пример:**
```
width = 1920
height = 1080
duration = 5.0
fps = 30.0
Результат:
  video_props = (объект)
  width = 1920
  height = 1080
  duration = 5.0
  fps = 30.0
  frames = 152 (округлено до кратного 4)
```

---

#### Lo:GetVideoProps
**Получение параметров видео**

Извлекает параметры из объекта `Lo:SetVideoProps`.

**Входы:**
- `video_props` (LO_VIDEO_PROPS) - Объект параметров видео

**Выходы:**
- `width` (INT) - Ширина
- `height` (INT) - Высота
- `duration` (FLOAT) - Продолжительность
- `fps` (FLOAT) - Кадров в секунду
- `frames` (INT) - Количество кадров
- `video_props` (LO_VIDEO_PROPS) - Объект параметров (для дальнейшей передачи)

---

## Утилиты

### Node Design

Позволяет настраивать цвет и форму выделеных узлов.
Вызывается через контекстное меню (Правый клик → **"Lo: Nodes Design"**).

**Особенности:**
- Изменения применяются ко всем выбранным узлам.
- Цвета можно вводить в веб формате (HSL, RGB, HEX), также можно вводить прозрачность. Пример: #00000033 — полупрозрачный черный.
- Палитра показывает все цвета, используемые в текущем графе


### Deprecated Nodes Banner

Если в текущем графе есть DEPRECATED узлы, в верхнем меню появится баннер



---

**Версия документации:** 1.0  
**Дата:** 2024
